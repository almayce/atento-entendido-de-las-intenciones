<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Atento — Lead Monitor</title>
  <link rel="stylesheet" href="/static/style.css">
  <script src="https://unpkg.com/htmx.org@2.0.4"></script>
  <script src="https://unpkg.com/htmx-ext-sse@2.2.2/sse.js"></script>
</head>
<body>
  <header>
    <h1>Atento</h1>
    <p class="subtitle">Telegram Lead Monitor</p>
  </header>

  <main>
    <section class="stats-panel">
      <div class="stat-card accent">
        <span class="stat-value">{{ leads }}</span>
        <span class="stat-label">Leads</span>
      </div>
      <div class="stat-card">
        <span class="stat-value">{{ total }}</span>
        <span class="stat-label">Total</span>
      </div>
      <div class="stat-card">
        <span class="stat-value">{{ lead_rate }}</span>
        <span class="stat-label">Lead Rate</span>
      </div>
      {% for stat in stats %}
      <div class="stat-card">
        <span class="stat-value">{{ stat.1 }}</span>
        <span class="stat-label">{{ stat.0 }}</span>
      </div>
      {% endfor %}
    </section>

    <section class="comments-section" hx-ext="sse" sse-connect="/sse">
      <h2>Comments</h2>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th class="sortable" data-col="0" data-type="lead">Lead</th>
              <th class="sortable" data-col="1" data-type="text">Канал</th>
              <th class="sortable" data-col="2" data-type="text">Автор</th>
              <th class="sortable" data-col="3" data-type="text">Ник</th>
              <th class="sortable" data-col="4" data-type="text">Телефон</th>
              <th>Комментарий</th>
              <th class="sortable" data-col="6" data-type="text">Интент</th>
              <th class="sortable" data-col="7" data-type="num">Уверен.</th>
              <th class="sortable" data-col="8" data-type="text">Время</th>
            </tr>
          </thead>
          <tbody id="comments-body" sse-swap="comment" hx-swap="afterbegin">
            {% for c in comments %}
            <tr class="comment-row {{ c.intent_css }}{% if c.is_lead %} is-lead{% endif %}">
              <td class="lead-cell">
                {% if c.is_lead %}
                <span class="lead-badge" title="{{ c.need_summary }}">LEAD {{ c.lead_score }}</span>
                {% endif %}
              </td>
              <td class="channel">{{ c.channel }}</td>
              <td class="author">{{ c.author }}</td>
              <td class="username">{{ c.username }}</td>
              <td class="phone">{{ c.phone }}</td>
              <td class="text">
                {{ c.text }}
                {% if c.is_lead %}
                <div class="need-summary">{{ c.need_summary }}</div>
                {% endif %}
              </td>
              <td class="intent"><span class="badge {{ c.intent_css }}">{{ c.intent }}</span></td>
              <td class="confidence">{{ c.confidence }}</td>
              <td class="date">{{ c.date }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <footer>
    <p>Atento v0.1.0</p>
  </footer>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const table = document.querySelector('table');
    const tbody = document.getElementById('comments-body');
    let sortCol = null;
    let sortAsc = false;

    table.querySelectorAll('th.sortable').forEach(th => {
      th.style.cursor = 'pointer';
      th.addEventListener('click', () => {
        const col = parseInt(th.dataset.col);
        const type = th.dataset.type;
        if (sortCol === col) {
          sortAsc = !sortAsc;
        } else {
          sortCol = col;
          sortAsc = true;
        }
        table.querySelectorAll('th.sortable').forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
        th.classList.add(sortAsc ? 'sort-asc' : 'sort-desc');

        const rows = Array.from(tbody.querySelectorAll('tr'));
        rows.sort((a, b) => {
          const aCell = a.cells[col];
          const bCell = b.cells[col];
          let aVal, bVal;
          if (type === 'lead') {
            aVal = aCell.querySelector('.lead-badge') ? parseFloat(aCell.textContent.match(/\d+/)?.[0] || '0') : -1;
            bVal = bCell.querySelector('.lead-badge') ? parseFloat(bCell.textContent.match(/\d+/)?.[0] || '0') : -1;
          } else if (type === 'num') {
            aVal = parseFloat(aCell.textContent.replace('%', '') || '0');
            bVal = parseFloat(bCell.textContent.replace('%', '') || '0');
          } else {
            aVal = aCell.textContent.trim().toLowerCase();
            bVal = bCell.textContent.trim().toLowerCase();
          }
          if (aVal < bVal) return sortAsc ? -1 : 1;
          if (aVal > bVal) return sortAsc ? 1 : -1;
          return 0;
        });
        rows.forEach(r => tbody.appendChild(r));
      });
    });
  });
  </script>
</body>
</html>
